import logging
from groq import AsyncGroq
from config import GROQ_API_KEY

logger = logging.getLogger(__name__)

class AIExplainer:
    """
    –ö–ª–∞—Å—Å –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å Groq API (Llama 3) –¥–ª—è –æ–±—ä—è—Å–Ω–µ–Ω–∏—è —É–≥—Ä–æ–∑ –∏ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–∞.
    """
    def __init__(self):
        self.enabled = bool(GROQ_API_KEY)
        if self.enabled:
            self.client = AsyncGroq(api_key=GROQ_API_KEY)
        else:
            self.client = None
            logger.warning("GROQ_API_KEY is not set. AI analysis disabled.")
        self.model = "llama-3.3-70b-versatile"
        
        # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–π–ª–æ–≤ (–∞–Ω—Ç–∏–≤–∏—Ä—É—Å–Ω—ã–π –æ—Ç—á–µ—Ç)
        self.file_system_prompt = (
            "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ PhishGuard. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ–±—ä—è—Å–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞. "
            "–í–ê–ñ–ù–û: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ï–©–ï –ù–ï –ó–ê–ü–£–°–ö–ê–õ —Ñ–∞–π–ª –∏ –∂–¥–µ—Ç —Ç–≤–æ–µ–≥–æ –≤–µ—Ä–¥–∏–∫—Ç–∞. "
            "1. –ù–∞–∑–≤–∞—Ç—å —Ç–∏–ø —É–≥—Ä–æ–∑—ã. "
            "2. –û–±—ä—è—Å–Ω–∏—Ç—å –æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏. "
            "3. –î–∞—Ç—å —á–µ—Ç–∫–∏–π —Å–æ–≤–µ—Ç: –ï–°–õ–ò –û–ü–ê–°–ù–û ‚Äî –ó–ê–ü–†–ï–¢–ò –û–¢–ö–†–´–í–ê–¢–¨. "
            "–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ."
        )

        # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–∞
        self.text_system_prompt = (
            "–¢—ã –∞–Ω–∞–ª–∏—Ç–∏–∫ –∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ PhishGuard. –¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –≤—ã—è–≤–ª–µ–Ω–∏—é –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞. "
            "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–∞–π—Ç–∏ –ø—Ä–∏–∑–Ω–∞–∫–∏ —Ñ–∏—à–∏–Ω–≥–∞, —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π –∏–Ω–∂–µ–Ω–µ—Ä–∏–∏ –∏ –°–ö–ê–ú–ê. "
            "–ë—É–¥—å –±–¥–∏—Ç–µ–ª–µ–Ω! –ú–æ—à–µ–Ω–Ω–∏–∫–∏ —á–∞—Å—Ç–æ –ø—Ä–∏–∫–∏–¥—ã–≤–∞—é—Ç—Å—è —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞–º–∏, –±–∞–Ω–∫–∞–º–∏ –∏–ª–∏ —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–æ–π. "
            "–¢—ã –ù–ï —á–∞—Ç-–±–æ—Ç. –¢–æ–ª—å–∫–æ –∞–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏."
        )

    async def explain_threat(self, threat_data: str) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —É–≥—Ä–æ–∑—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç VirusTotal.
        """
        if not self.enabled:
            return "–ò–ò-–∞–Ω–∞–ª–∏–∑ –æ—Ç–∫–ª—é—á–µ–Ω: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–ª—é—á GROQ_API_KEY."
        try:
            chat_completion = await self.client.chat.completions.create(
                messages=[
                    {
                        "role": "system",
                        "content": self.file_system_prompt,
                    },
                    {
                        "role": "user",
                        "content": f"–í–æ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –æ–± –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã—Ö —É–≥—Ä–æ–∑–∞—Ö –≤ —Ñ–∞–π–ª–µ: {threat_data}",
                    }
                ],
                model=self.model,
            )
            return chat_completion.choices[0].message.content
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ Groq API: {e}")
            return "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –æ—Ç –ò–ò."

    async def analyze_text(self, text: str, vt_stats: dict = None) -> str:
        """
        –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π –∏–Ω–∂–µ–Ω–µ—Ä–∏–∏ –∏ —Ñ–∏—à–∏–Ω–≥–∞.
        """
        if not self.enabled:
            return "–ò–ò-–∞–Ω–∞–ª–∏–∑ –æ—Ç–∫–ª—é—á–µ–Ω: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–ª—é—á GROQ_API_KEY."
        vt_context = ""
        if vt_stats:
            vt_context = f"\n–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å—Å—ã–ª–∫–∏ (VirusTotal): {vt_stats}"
        
        prompt = (
            f"–¢–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞: \"{text}\"{vt_context}\n\n"
            "–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –Ω–µ—Å–µ—Ç –ª–∏ —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç —É–≥—Ä–æ–∑—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.\n\n"
            "–ö–†–ò–¢–ï–†–ò–ò –û–¶–ï–ù–ö–ò:\n"
            "1. üî¥ –û–ü–ê–°–ù–û (–°–ö–ê–ú/–§–ò–®–ò–ù–ì): –°—Ä–æ—á–Ω–æ—Å—Ç—å, —É–≥—Ä–æ–∑—ã –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏, –ø–æ–¥–¥–µ–ª—å–Ω—ã–µ —Å–∞–π—Ç—ã –±–∞–Ω–∫–æ–≤/–≥–æ—Å—É—Å–ª—É–≥, –∫—Ä–∞–∂–∞ –¥–∞–Ω–Ω—ã—Ö.\n"
            "2. üü° –ü–û–î–û–ó–†–ò–¢–ï–õ–¨–ù–û: –õ—é–±—ã–µ –ø—Ä–æ—Å—å–±—ã –ü–ï–†–ï–í–ï–°–¢–ò –î–ï–ù–¨–ì–ò (–¥–∞–∂–µ –æ—Ç '–º–∞–º—ã', '–¥—Ä—É–≥–∞', '–∫–æ–ª–ª–µ–≥–∏'), –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ª–µ–≥–∫–æ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∫–∞, –≤—ã–∏–≥—Ä—ã—à–∏ –≤ –ª–æ—Ç–µ—Ä–µ—é.\n"
            "3. üü¢ –ë–ï–ó–û–ü–ê–°–ù–û: –û–±—ã—á–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ –±–µ–∑ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –ø—Ä–æ—Å—å–±, –Ω–æ–≤–æ—Å—Ç–∏, –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏.\n\n"
            "–í–ê–ñ–ù–û:\n"
            "- –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –ø—Ä–æ—Å—è—Ç –î–ï–ù–¨–ì–ò –∏–ª–∏ –Ω–æ–º–µ—Ä –ö–ê–†–¢–´ ‚Äî —ç—Ç–æ –º–∏–Ω–∏–º—É–º –ü–û–î–û–ó–†–ò–¢–ï–õ–¨–ù–û.\n"
            "- –ú–æ—à–µ–Ω–Ω–∏–∫–∏ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Å—Ö–µ–º—É '–ú–∞–º, —Å–∫–∏–Ω—å –¥–µ–Ω–µ–≥'. –¢–≤–æ–π —Å–æ–≤–µ—Ç –≤ —Ç–∞–∫–æ–º —Å–ª—É—á–∞–µ: '–°–≤—è–∂–∏—Ç–µ—Å—å —Å —á–µ–ª–æ–≤–µ–∫–æ–º –ª–∏—á–Ω–æ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —ç—Ç–æ –æ–Ω'.\n\n"
            "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:\n"
            "1. –í–ï–†–î–ò–ö–¢: (üî¥ –û–ü–ê–°–ù–û / üü° –ü–û–î–û–ó–†–ò–¢–ï–õ–¨–ù–û / üü¢ –ë–ï–ó–û–ü–ê–°–ù–û)\n"
            "2. –ê–ù–ê–õ–ò–ó: (–ü–æ—á–µ–º—É —Ç—ã —Ç–∞–∫ —Ä–µ—à–∏–ª? –ö—Ä–∞—Ç–∫–æ.)\n"
            "3. –°–û–í–ï–¢: (–ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é?)\n\n"
            "–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ."
        )

        try:
            chat_completion = await self.client.chat.completions.create(
                messages=[
                    {
                        "role": "system",
                        "content": self.text_system_prompt,
                    },
                    {
                        "role": "user",
                        "content": prompt,
                    }
                ],
                model=self.model,
            )
            return chat_completion.choices[0].message.content
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Ç–µ–∫—Å—Ç–∞ Groq API: {e}")
            return "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞."