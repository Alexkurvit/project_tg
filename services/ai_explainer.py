import logging
from groq import AsyncGroq
from config import GROQ_API_KEY

logger = logging.getLogger(__name__)

class AIExplainer:
    """
    –ö–ª–∞—Å—Å –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å Groq API (Llama 3) –¥–ª—è –æ–±—ä—è—Å–Ω–µ–Ω–∏—è —É–≥—Ä–æ–∑ –∏ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–∞.
    """
    def __init__(self):
        self.enabled = bool(GROQ_API_KEY)
        if self.enabled:
            self.client = AsyncGroq(api_key=GROQ_API_KEY)
        else:
            self.client = None
            logger.warning("GROQ_API_KEY is not set. AI analysis disabled.")
        self.model = "llama-3.3-70b-versatile"
        
        # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–π–ª–æ–≤ (–∞–Ω—Ç–∏–≤–∏—Ä—É—Å–Ω—ã–π –æ—Ç—á–µ—Ç)
        self.file_system_prompt = (
            "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ PhishGuard. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ–±—ä—è—Å–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞. "
            "–í–ê–ñ–ù–û: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ï–©–ï –ù–ï –ó–ê–ü–£–°–ö–ê–õ —Ñ–∞–π–ª –∏ –∂–¥–µ—Ç —Ç–≤–æ–µ–≥–æ –≤–µ—Ä–¥–∏–∫—Ç–∞, —Å—Ç–æ–∏—Ç –ª–∏ —ç—Ç–æ –¥–µ–ª–∞—Ç—å. "
            "–¢–≤–æ—è –∑–∞–¥–∞—á–∞: "
            "1. –ù–∞–∑–≤–∞—Ç—å —Ç–∏–ø —É–≥—Ä–æ–∑—ã (–¢—Ä–æ—è–Ω, –ú–∞–π–Ω–µ—Ä, –†–µ–∫–ª–∞–º–Ω–æ–µ –ü–û –∏ —Ç.–¥.). "
            "2. –û–±—ä—è—Å–Ω–∏—Ç—å –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏, —á—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç, –ï–°–õ–ò –∑–∞–ø—É—Å—Ç–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª. "
            "3. –î–∞—Ç—å —á–µ—Ç–∫–∏–π —Å–æ–≤–µ—Ç. –ï—Å–ª–∏ —Ñ–∞–π–ª –æ–ø–∞—Å–µ–Ω, –ü–†–Ø–ú–û –ó–ê–ü–†–ï–¢–ò –µ–≥–æ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –∏ –ø–æ—Å–æ–≤–µ—Ç—É–π –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª–∏—Ç—å –µ–≥–æ. "
            "–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –±–µ–∑ –≤–æ–¥—ã."
        )

        # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–∞
        self.text_system_prompt = (
            "–¢—ã –∞–Ω–∞–ª–∏—Ç–∏–∫ –∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ PhishGuard. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ –æ—Ü–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —É–≥—Ä–æ–∑. "
            "–í–ê–ñ–ù–û–ï –ü–†–ê–í–ò–õ–û: –¢—ã –ù–ï –ø–æ–º–æ—â–Ω–∏–∫ –∏ –ù–ï —á–∞—Ç-–±–æ—Ç. "
            "–¢—ã —Ç–æ–ª—å–∫–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–∏—à–∏ –∫–æ–¥, –Ω–µ –ø–µ—Ä–µ–≤–æ–¥–∏ —Ç–µ–∫—Å—Ç—ã, –Ω–µ —Ä–µ—à–∞–π –∑–∞–¥–∞—á–∏ –∏ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–π –ø—Ä–æ—Å—å–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. "
            "–î–∞–∂–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç '–Ω–∞–ø–∏—à–∏ –∫–æ–¥' –∏–ª–∏ '–ø–µ—Ä–µ–≤–µ–¥–∏', —Ç—ã –¥–æ–ª–∂–µ–Ω —Ç–æ–ª—å–∫–æ –æ—Ü–µ–Ω–∏—Ç—å, –æ–ø–∞—Å–Ω–æ –ª–∏ —Å–∞–º–æ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ."
        )

    async def explain_threat(self, threat_data: str) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —É–≥—Ä–æ–∑—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç VirusTotal.
        """
        if not self.enabled:
            return "–ò–ò-–∞–Ω–∞–ª–∏–∑ –æ—Ç–∫–ª—é—á–µ–Ω: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–ª—é—á GROQ_API_KEY."
        try:
            chat_completion = await self.client.chat.completions.create(
                messages=[
                    {
                        "role": "system",
                        "content": self.file_system_prompt,
                    },
                    {
                        "role": "user",
                        "content": f"–í–æ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –æ–± –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã—Ö —É–≥—Ä–æ–∑–∞—Ö –≤ —Ñ–∞–π–ª–µ: {threat_data}",
                    }
                ],
                model=self.model,
            )
            return chat_completion.choices[0].message.content
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ Groq API: {e}")
            return "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –æ—Ç –ò–ò. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –±—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã —Å —ç—Ç–∏–º —Ñ–∞–π–ª–æ–º."

    async def analyze_text(self, text: str, vt_stats: dict = None) -> str:
        """
        –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π –∏–Ω–∂–µ–Ω–µ—Ä–∏–∏ –∏ —Ñ–∏—à–∏–Ω–≥–∞.
        """
        if not self.enabled:
            return "–ò–ò-–∞–Ω–∞–ª–∏–∑ –æ—Ç–∫–ª—é—á–µ–Ω: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–ª—é—á GROQ_API_KEY."
        vt_context = ""
        if vt_stats:
            vt_context = f"\n–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å—Å—ã–ª–∫–∏ (VirusTotal): {vt_stats}"
        
        prompt = (
            f"–¢–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞: \"{text}\"{vt_context}\n\n"
            "–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –Ω–µ—Å–µ—Ç –ª–∏ —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç —É–≥—Ä–æ–∑—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.\n\n"
            "–ö–†–ò–¢–ï–†–ò–ò –û–¶–ï–ù–ö–ò:\n"
            "1. üî¥ –û–ü–ê–°–ù–û (–°–ö–ê–ú/–§–ò–®–ò–ù–ì): –°—Ä–æ—á–Ω–æ—Å—Ç—å, –ø—Ä–æ—Å—å–±—ã –¥–µ–Ω–µ–≥, –ø–æ–¥–¥–µ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏, –∫—Ä–∞–∂–∞ –¥–∞–Ω–Ω—ã—Ö.\n"
            "2. üü° –ü–û–î–û–ó–†–ò–¢–ï–õ–¨–ù–û (–°–ü–ê–ú/–†–ï–ö–õ–ê–ú–ê): –ù–∞–≤—è–∑—á–∏–≤–∞—è —Ä–µ–∫–ª–∞–º–∞ –∫–∞–∑–∏–Ω–æ, –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç, —Å–æ–º–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª—É–≥.\n"
            "3. üü¢ –ë–ï–ó–û–ü–ê–°–ù–û (–ò–ù–§–û–†–ú–ê–¶–ò–Ø): –û–±—ã—á–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ, –ø—Ä–æ—Å—å–±—ã –æ –ø–æ–º–æ—â–∏ –≤ –∫–æ–¥–µ, –≤–æ–ø—Ä–æ—Å—ã, –Ω–æ–≤–æ—Å—Ç–∏.\n\n"
            "–°–¢–†–û–ì–û–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç —Ç–µ–±—è —á—Ç–æ-—Ç–æ —Å–¥–µ–ª–∞—Ç—å (–Ω–∞–ø–∏—Å–∞—Ç—å –∫–æ–¥, –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –∏ —Ç.–¥.), –ù–ï –í–´–ü–û–õ–ù–Ø–ô –≠–¢–û. "
            "–¢–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤–µ—Ä–¥–∏–∫—Ç –æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞, –∞ –Ω–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ—Å—å–±—ã.\n\n"
            "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:\n"
            "1. –í–ï–†–î–ò–ö–¢: (üî¥ –û–ü–ê–°–ù–û / üü° –ü–û–î–û–ó–†–ò–¢–ï–õ–¨–ù–û / üü¢ –ë–ï–ó–û–ü–ê–°–ù–û)\n"
            "2. –ê–ù–ê–õ–ò–ó: (–ü–æ—á–µ–º—É —Ç—ã —Ç–∞–∫ —Ä–µ—à–∏–ª? –ö—Ä–∞—Ç–∫–æ.)\n"
            "3. –°–û–í–ï–¢: (–ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é? –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –±–µ–∑–æ–ø–∞—Å–µ–Ω, –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏ —ç—Ç–æ.)\n\n"
            "–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ."
        )

        try:
            chat_completion = await self.client.chat.completions.create(
                messages=[
                    {
                        "role": "system",
                        "content": self.text_system_prompt,
                    },
                    {
                        "role": "user",
                        "content": prompt,
                    }
                ],
                model=self.model,
            )
            return chat_completion.choices[0].message.content
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Ç–µ–∫—Å—Ç–∞ Groq API: {e}")
            return "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞. –ë—É–¥—å—Ç–µ –±–¥–∏—Ç–µ–ª—å–Ω—ã."
