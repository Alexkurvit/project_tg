import logging
from groq import AsyncGroq
from config import GROQ_API_KEY

logger = logging.getLogger(__name__)

class AIExplainer:
    """
    –ö–ª–∞—Å—Å –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å Groq API (Llama 3) –¥–ª—è –æ–±—ä—è—Å–Ω–µ–Ω–∏—è —É–≥—Ä–æ–∑ –∏ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–∞.
    """
    def __init__(self):
        self.enabled = bool(GROQ_API_KEY)
        if self.enabled:
            self.client = AsyncGroq(api_key=GROQ_API_KEY)
        else:
            self.client = None
            logger.warning("GROQ_API_KEY is not set. AI analysis disabled.")
        self.model = "llama-3.3-70b-versatile"
        
        # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–π–ª–æ–≤ (–∞–Ω—Ç–∏–≤–∏—Ä—É—Å–Ω—ã–π –æ—Ç—á–µ—Ç)
        self.file_system_prompt = (
            "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –¢–≤–æ—è –∞—É–¥–∏—Ç–æ—Ä–∏—è ‚Äî –æ–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏. "
            "–¢–µ–±–µ –ø—Ä–∏—à–µ–ª –æ—Ç—á–µ—Ç VirusTotal. –¢–≤–æ—è –∑–∞–¥–∞—á–∞: "
            "1. –ù–∞–∑–≤–∞—Ç—å —Ç–∏–ø —É–≥—Ä–æ–∑—ã (–¢—Ä–æ—è–Ω, –ú–∞–π–Ω–µ—Ä, –†–µ–∫–ª–∞–º–Ω–æ–µ –ü–û –∏ —Ç.–¥.). "
            "2. –û–±—ä—è—Å–Ω–∏—Ç—å –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏, —á–µ–º —ç—Ç–æ –æ–ø–∞—Å–Ω–æ –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞. "
            "3. –î–∞—Ç—å —á–µ—Ç–∫–∏–π —Å–æ–≤–µ—Ç (—É–¥–∞–ª–∏—Ç—å, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–æ–º –∏ —Ç.–¥.). "
            "–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –±–µ–∑ –≤–æ–¥—ã."
        )

        # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–∞
        self.text_system_prompt = (
            "–¢—ã –∞–Ω–∞–ª–∏—Ç–∏–∫ –∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ PhishGuard. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ –æ—Ü–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è. "
            "–ù–µ –ø—É–≥–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑—Ä—è. –û—Ç–ª–∏—á–∞–π —Ä–µ–∞–ª—å–Ω—ã–π —Ñ–∏—à–∏–Ω–≥ –æ—Ç –æ–±—ã—á–Ω–æ–π —Ä–µ–∫–ª–∞–º—ã –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—è –ø–æ–ª–µ–∑–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤."
        )

    async def explain_threat(self, threat_data: str) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —É–≥—Ä–æ–∑—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç VirusTotal.
        """
        if not self.enabled:
            return "–ò–ò-–∞–Ω–∞–ª–∏–∑ –æ—Ç–∫–ª—é—á–µ–Ω: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–ª—é—á GROQ_API_KEY."
        try:
            chat_completion = await self.client.chat.completions.create(
                messages=[
                    {
                        "role": "system",
                        "content": self.file_system_prompt,
                    },
                    {
                        "role": "user",
                        "content": f"–í–æ—Ç –¥–∞–Ω–Ω—ã–µ –æ–± —É–≥—Ä–æ–∑–µ: {threat_data}",
                    }
                ],
                model=self.model,
            )
            return chat_completion.choices[0].message.content
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ Groq API: {e}")
            return "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –æ—Ç –ò–ò. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –±—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã —Å —ç—Ç–∏–º —Ñ–∞–π–ª–æ–º."

    async def analyze_text(self, text: str, vt_stats: dict = None) -> str:
        """
        –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π –∏–Ω–∂–µ–Ω–µ—Ä–∏–∏ –∏ —Ñ–∏—à–∏–Ω–≥–∞.
        –£—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç, —á—Ç–æ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.
        """
        if not self.enabled:
            return "–ò–ò-–∞–Ω–∞–ª–∏–∑ –æ—Ç–∫–ª—é—á–µ–Ω: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–ª—é—á GROQ_API_KEY."
        vt_context = ""
        if vt_stats:
            vt_context = f"\n–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å—Å—ã–ª–∫–∏ (VirusTotal): {vt_stats}"
        
        prompt = (
            f"–¢–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞: \"{text}\"{vt_context}\n\n"
            "–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –Ω–µ—Å–µ—Ç –ª–∏ —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç —É–≥—Ä–æ–∑—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.\n\n"
            "–ö–†–ò–¢–ï–†–ò–ò –û–¶–ï–ù–ö–ò:\n"
            "1. üî¥ –û–ü–ê–°–ù–û (–°–ö–ê–ú/–§–ò–®–ò–ù–ì): –°—Ä–æ—á–Ω–æ—Å—Ç—å (\"–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω!\"), –ø—Ä–æ—Å—å–±—ã –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –¥–µ–Ω—å–≥–∏, —Ñ–∞–ª—å—à–∏–≤—ã–µ —Å—Å—ã–ª–∫–∏ (–Ω–∞ –±–∞–Ω–∫–∏, –≥–æ—Å—É—Å–ª—É–≥–∏), –∫—Ä–∞–∂–∞ –¥–∞–Ω–Ω—ã—Ö.\n"
            "2. üü° –ü–û–î–û–ó–†–ò–¢–ï–õ–¨–ù–û (–°–ü–ê–ú/–†–ï–ö–õ–ê–ú–ê): –ù–∞–≤—è–∑—á–∏–≤–∞—è —Ä–µ–∫–ª–∞–º–∞ –∫–∞–∑–∏–Ω–æ, –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç –∏–ª–∏ —Å–æ–º–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞—Ä–∞–±–æ—Ç–∫–æ–≤.\n"
            "3. üü¢ –ë–ï–ó–û–ü–ê–°–ù–û (–ò–ù–§–û–†–ú–ê–¶–ò–Ø): –û–±—ã—á–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ, –Ω–æ–≤–æ—Å—Ç–∏, –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª–µ–∑–Ω—ã—Ö –±–æ—Ç–æ–≤/–ø—Ä–æ–≥—Ä–∞–º–º, —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (Telegram, YouTube –∏ —Ç.–¥.), —à—É—Ç–∫–∏.\n\n"
            "–í–ê–ñ–ù–û:\n"
            "- –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø—Ä–æ—Å—Ç–æ –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –±–æ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, \"–ó–∞—â–∏—Ç–∞ –æ—Ç –≤–∑–ª–æ–º–∞\", \"–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤\") ‚Äî —ç—Ç–æ –ë–ï–ó–û–ü–ê–°–ù–û.\n"
            "- –°—Å—ã–ª–∫–∞ –Ω–∞ —Å–∞–º–æ–≥–æ —Å–µ–±—è (PhishGuard) –∏–ª–∏ –¥—Ä—É–≥–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ ‚Äî —ç—Ç–æ –ë–ï–ó–û–ü–ê–°–ù–û.\n\n"
            "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:\n"
            "1. –í–ï–†–î–ò–ö–¢: (üî¥ –û–ü–ê–°–ù–û / üü° –°–ü–ê–ú / üü¢ –ë–ï–ó–û–ü–ê–°–ù–û)\n"
            "2. –ê–ù–ê–õ–ò–ó: (–ö—Ä–∞—Ç–∫–æ –æ–±—ä—è—Å–Ω–∏ —Å—É—Ç—å —Ç–µ–∫—Å—Ç–∞: —ç—Ç–æ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ, —Ä–µ–∫–ª–∞–º–∞ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –æ–ø–∏—Å–∞–Ω–∏–µ)\n"
            "3. –°–û–í–ï–¢: (–ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é)\n\n"
            "–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, —á–µ—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É."
        )

        try:
            chat_completion = await self.client.chat.completions.create(
                messages=[
                    {
                        "role": "system",
                        "content": self.text_system_prompt,
                    },
                    {
                        "role": "user",
                        "content": prompt,
                    }
                ],
                model=self.model,
            )
            return chat_completion.choices[0].message.content
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Ç–µ–∫—Å—Ç–∞ Groq API: {e}")
            return "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞. –ë—É–¥—å—Ç–µ –±–¥–∏—Ç–µ–ª—å–Ω—ã."
